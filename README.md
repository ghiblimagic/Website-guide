This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Analytics

This project uses PostHog for analytics.

**Summary** To track website usage while respecting privacy laws, I switched to anonymous analytics: no cookies are set, and pageviews are logged using a truncated IP + partial User-Agent. This avoids GDPR & california cookie consent requirements, but it means we can’t track individual users across sessions.

**Problem**: Netlify no longer has a free analytics service and next.js no longer allows for external domains to use its vercel/analytics package on projects not hosted on vercel.

**Solution**: I choose posthog due to its generous free tier. I couldn't move the project to Next.js since guide.janetspellman is a subdomain of my astro portfolio's domain janetspellman.com.

**Problem**: Post-hog's client js would be blocked by adblockers like ublock.

**Solution**: Setup posthog in a middleware component & used posthog-node. Since its server rendered, theres no js code to block.

**Problem**: Initial approach: Set a persistent cookie (website_guide_visitor_id) to uniquely identify users across sessions. However:

Setting cookies counts as non-essential tracking under GDPR/ePrivacy, so we’d legally need a cookie banner for consent.

Users with strict privacy browsers (Brave, Firefox with strict mode) may block cookies → inaccurate metrics.

Fallback fingerprinting (IP + User-Agent) could still be considered personal data, which also requires consent.

**Solution** No cookies, Anonymous ID are generated by combining a truncated IP and partial User-Agent.

`${request.ip.split(".").slice(0, 3).join(".")}- + `

- Only grab the first 3 ocets of the id
- Cannot uniquely identify an individual from a truncated IP alone in most cases

`${request.headers.get("user-agent")?.slice(0, 20) || "unknown"}`

- first 20 characters of the UA string: This captures browser type/version, maybe OS — not a unique fingerprint.
- By itself, it’s not considered personally identifiable.

**Problem**

- Truncated IP + partial UA could, in theory, be used to approximate a user on a shared network, but it’s still pseudonymous, not directly identifying.

**Solution** hash the Truncated IP + partial UA before sending it to posthog

- So even if someone intercepts the analytics they they cannot reconstruct the IP + UA, making it more privacy-friendly.

- Unfortunately the crypto package isn't available in middleware/edge function. So a simple hash function was used. It's Deterministic → same input always produces same output so it wouldn't be secure for passwords, but in this case, its just to help make the truncated Ids more extra anonymous.

**Cons**

1. If users are accessing the site from a shared network such as a public wifi in a coffee shop, users using the same user agent (firefox browser, ect) will be tracked as one person.
2. Cannot reliably track returning users. Returning visitors will get a new id in these cases and thus appear as a new vistor:

- A browser update (UA change)
- If their IP changes, such as them going to starbucks they'll get a new id as well

**Pros**

1. Get basic tracking while following GDPR and california laws
2. Avoid the negative UX experience of a cookie banner
